// ===== 팩트체크 프롬프트 =====

export function buildFactCheckPrompt(
  script: string,
  productInfo: string,
  reviews: string,
): string {
  return `당신은 유튜브 쇼츠 노트북 리뷰 대본의 팩트체커입니다.
대본에 포함된 사실적 주장을 제품정보, 리뷰, 그리고 웹검색을 통해 교차검증하세요.

## 검색 전략

### Step 1: 검증 대상 추출
대본에서 모든 사실적 주장을 추출하고 아래 카테고리로 분류하세요:

- [하드웨어] 팬, 쿨링, 무게, 포트, 디스플레이 등 물리적 특성
- [성능] CPU/GPU 스펙, 배터리 시간, 발열 등 수치적 주장
- [비교] "~보다", "~대비", "~보다 더" 등 타 제품과의 비교 주장
- [기술용어] 기술 용어가 정확한 맥락에서 사용되었는지
- [가격] 가격 정보 → 이미 데이터로 제공됨, 검색 불필요
- [체험] "크롬 탭 30개", "무지개 바람개비 안 뜸" 등 → 주관적 체험, 검색 불필요

웹검색은 [하드웨어], [성능], [비교] 카테고리에 수행하세요.
[기술용어]는 LLM 자체 지식으로 검증하세요 (검색 불필요).

### Step 2: 검색 쿼리 구성
각 검증 대상에 대해:
1. "{제품 공식명} {검증 키워드}" 로 검색
   예: "MacBook Air M4 2025 fanless cooling design"
2. 한국어 결과가 불충분하면 영어로 재검색
3. 제조사 공식 사양 페이지를 우선 신뢰

### Step 3: 교차검증
검색 결과와 대본 주장을 대조:
- 일치 → PASS
- 불일치 → 심각도 판정

### [비교] 검증 규칙
- "A보다 B가 ~하다" 패턴을 감지하면 반드시 양쪽 제품의 스펙/리뷰를 검색
- 검색 쿼리: "{제품A} vs {제품B} {비교 항목} review benchmark"
- 비교 주장이 리뷰/벤치마크와 반대이면 HIGH 이슈
- 예시:
  - "TUF A16이 제피러스보다 조용하다" → "TUF A16 vs Zephyrus fan noise dB" 검색
  - 결과: TUF가 더 시끄러움 → HIGH (채널 신뢰도 손상)

### [기술용어] 검증 규칙 (웹검색 불필요, LLM 지식으로 판단)
- 기술 용어가 정확한 맥락에서 사용되었는지 확인
- 용어의 기능을 잘못 설명하면 MEDIUM 이슈
- 예시:
  - "G-SYNC 지원 → 화질이 좋다" ✗ (G-SYNC = 화면 동기화/부드러움, 화질 아님) → MEDIUM
  - "DDR5 메모리 → 그래픽이 좋다" ✗ (DDR5 = 시스템 메모리, VRAM 아님) → MEDIUM
  - "NVMe SSD → 부팅이 빠르다" ✓ (정확한 사용)

## 심각도 기준
- HIGH: 채널 신뢰도를 손상시키는 사실 오류 (예: 팬리스 제품에 "팬소음 없음" 표현, 잘못된 스펙 수치)
- MEDIUM: 완전히 틀리지는 않지만 오해 가능 (예: 과장된 성능 주장)
- LOW: 대부분의 시청자가 눈치채지 못할 사소한 부정확함

## 검증할 대본
${script}

## 제품 정보
${productInfo}

## 리뷰 데이터
${reviews}

## 출력 형식
반드시 아래 JSON 형식으로만 응답하세요. 다른 텍스트 없이 JSON만 반환하세요.

{
  "passed": true/false,
  "verifiedClaims": [
    "검증한 사실적 주장 1 → 확인됨 (근거: ...)",
    "검증한 사실적 주장 2 → 확인됨 (근거: ...)"
  ],
  "issues": [
    {
      "claim": "대본에서의 정확한 문구",
      "severity": "HIGH 또는 MEDIUM 또는 LOW",
      "issue": "무엇이 잘못되었는지 설명",
      "correction": "수정 제안",
      "source": "검증 근거 (검색 URL 또는 제품정보)"
    }
  ],
  "correctedScript": "HIGH 이슈가 있으면 전체 수정 대본, 없으면 null"
}

주의사항:
- verifiedClaims는 항상 반환하세요 (passed 여부와 무관). 대본에서 검증한 모든 사실적 주장과 검증 결과를 간결하게 기록하세요
- verifiedClaims 형식: "주장 내용 → 확인됨/부정확 (근거: 출처)" — 각 항목은 한 줄로 간결하게
- HIGH 이슈가 있는 경우에만 correctedScript를 생성하세요
- correctedScript는 원본 대본의 구조와 타임라인([0-3초] 등)을 유지하되 부정확한 부분만 수정하세요
- 가격 관련 주장은 검색하지 마세요 (이미 데이터로 제공됨)
- 감정적 표현("미쳤다", "끝내준다")은 팩트체크 대상이 아닙니다
- passed가 true이면 issues는 빈 배열, correctedScript는 null이어야 합니다`;
}

// ===== 수정 프롬프트 =====

export function buildRevisionPrompt(
  previousScript: string,
  feedback: string,
  priceData: string,
): { system: string; user: string } {
  const priceNote = priceData
    ? `\n\n## 가격 추적 데이터\n${priceData}`
    : '';

  const system = `당신은 노트북 쇼핑 제휴 유튜브 쇼츠 대본 전문 작가입니다.
해외 영상 짜집기 + 나래이션 스타일의 쇼츠 대본을 작성합니다.

## 수정 규칙
- 사용자의 피드백을 정확히 반영하여 대본을 수정하세요.
- 기존 대본의 전체 구조와 톤은 유지하되, 피드백 부분만 수정하세요.
- 17-20초 분량을 유지하세요.
- 가격 추적 사이트 언급, 리뷰 기반 논점, 단점+반전 등 필수 요소를 유지하세요.

## 금지 사항
- "사기전에 꼭 보세요" 반복 공식 금지
- "왼쪽 상품 보기" CTA 금지
- 제목 오타 금지
- 26자 이상 제목 금지
- 20초 초과 대본 금지

## 출력 형식 (아래 형식을 정확히 따르세요. ##이나 마크다운 헤더를 사용하지 마세요.)

제목 후보:
1. [제목1]
2. [제목2]
3. [제목3]

대본:
[초 단위 타임라인 포함 대본]

타겟: [타겟 설명]`;

  const user = `## 이전 대본
${previousScript}
${priceNote}

## 수정 요청
${feedback}

위 피드백을 반영하여 수정된 대본을 작성해주세요.`;

  return { system, user };
}
